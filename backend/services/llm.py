import anthropic
import json
from core.config import settings

RESEARCH_REPORT_PROMPT = """
ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ìµœê³ ì˜ ê¸ˆìœµ ìì‚° ë¶„ì„ê°€(Senior Equity Analyst)ì…ë‹ˆë‹¤.
ì œê³µëœ ì¢…ëª© ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì°¨íŠ¸ì˜ ì‹œê°ì  ìš”ì†Œë¥¼ í…ìŠ¤íŠ¸ë¡œ í’€ì–´ë‚´ëŠ” ê¹Šì´ ìˆëŠ” ë¦¬ì„œì¹˜ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì‹­ì‹œì˜¤.

## í•µì‹¬ ìš”êµ¬ì‚¬í•­
- **í†¤ ì•¤ ë§¤ë„ˆ**: ë¶„ì„ì , ì„œìˆ ì , í†µì°°ë ¥ ì¤‘ì‹¬. (ë‹¨ìˆœ ìˆ˜ì¹˜ ë‚˜ì—´ì´ ì•„ë‹Œ 'ë§¥ë½' ì„¤ëª…)
- **ì°¨íŠ¸ í•´ì„¤ ê°€ì´ë“œ**: ê° ë¶„ì„ ì„¹ì…˜ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œ ì°¨íŠ¸ì˜ **xì¶•(ì‹œê°„/ë¶„ê¸°)ê³¼ yì¶•(ìˆ˜ì¹˜/ë¹„ìœ¨)**ì´ ì˜ë¯¸í•˜ëŠ” ë°”ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ë©° íë¦„ì„ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
- **ë¶„ëŸ‰**: ì „ì²´ JSON ì‘ë‹µì˜ í…ìŠ¤íŠ¸ ì´í•©ì´ **í•œê¸€ ê¸°ì¤€ ì•½ 2000ì** ë‚´ì™¸ê°€ ë˜ë„ë¡ í’ë¶€í•˜ê²Œ ì„œìˆ í•˜ì‹­ì‹œì˜¤.
- **ì–¸ì–´**: í•œêµ­ì–´

## ì„¹ì…˜ë³„ ìƒì„¸ ì‘ì„± ì§€ì¹¨ (JSON ê° í•„ë“œ)
1. `executive_summary`: ì „ì²´ ë¦¬í¬íŠ¸ì˜ í•µì‹¬ ìš”ì•½ ë° ìµœì¢… íˆ¬ì íŒë‹¨. ì°¨íŠ¸ë“¤ì˜ ì¢…í•©ì ì¸ ê²°ë¡ ì„ **5~7ë¬¸ì¥**ìœ¼ë¡œ ìƒì„¸íˆ ì„œìˆ í•˜ì‹­ì‹œì˜¤.
2. `fundamental_analysis`: ë§¤ì¶œ/ì˜ì—…ì´ìµ ì¶”ì„¸ ì°¨íŠ¸ë¥¼ ì„¤ëª…í•˜ì‹­ì‹œì˜¤. 
   - "xì¶•ì˜ ì „ë¶„ê¸° ëŒ€ë¹„ ë§¤ì¶œ ì„±ì¥ì´ yì¶•ì˜ ìˆ˜ìµì„± ê°œì„ ìœ¼ë¡œ ì–´ë–»ê²Œ ì´ì–´ì§€ê³  ìˆëŠ”ì§€" ë“± ì°¨íŠ¸ì˜ íë¦„ì„ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
3. `valuation_analysis`: ë°¸ë¥˜ì—ì´ì…˜ ê²Œì´ì§€ ë° ì¬ë¬´ ì§€í‘œë¥¼ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
   - PEG, ROE, ìœ ë™ë¹„ìœ¨ ìˆ˜ì¹˜ê°€ í˜„ì¬ ì£¼ê°€(yì¶•) ëŒ€ë¹„ ì–´ëŠ ì§€ì ì— ìœ„ì¹˜í•˜ë©°, ì´ê²ƒì´ ê°–ëŠ” ì•ˆì „ë§ˆì§„ì˜ ì˜ë¯¸ë¥¼ ì„œìˆ í•˜ì‹­ì‹œì˜¤.
4. `technical_analysis`: RSI ë° ì´ë™í‰ê· ì„  ì°¨íŠ¸ë¥¼ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
   - "xì¶•ì˜ ì‹œê°„ íë¦„ì— ë”°ë¥¸ ì´í‰ì„ ì˜ ê¸°ìš¸ê¸° ë³€í™”"ì™€ "RSI ë§‰ëŒ€ê°€ íŠ¹ì • ì„ê³„ê°’ì„ ë„˜ì—ˆì„ ë•Œì˜ ì‹œì¥ ì‹¬ë¦¬"ë¥¼ ë¶„ì„í•˜ì‹­ì‹œì˜¤.
5. `risk_analysis`: MDD ë° ë³€ë™ì„± ì°¨íŠ¸ë¥¼ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
   - xì¶•ì˜ ì—­ì‚¬ì  í•˜ë½ êµ¬ê°„ì—ì„œ yì¶•ì˜ MDDê°€ ì‹œì‚¬í•˜ëŠ” ìœ„í—˜ì˜ í¬ê¸°ì™€, í–¥í›„ ë°œìƒ ê°€ëŠ¥í•œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¬ì¸µ ë¶„ì„í•˜ì‹­ì‹œì˜¤.

## ì˜ˆì‹œ ë‹µë³€ (JSON í˜•ì‹)
```json
{
  "investment_rating": "ë³´ìœ  (HOLD)",
  "current_price": 72500,
  "key_thesis": "ë§¤ì¶œ ì„±ì¥ì˜ ê¸°ìš¸ê¸° ë‘”í™”ì—ë„ ë¶ˆêµ¬í•˜ê³  ì˜ì—…ì´ìµë¥ ì˜ ì§ˆì  ê°œì„ ê³¼ ì¥ê¸° ì´í‰ì„ ì˜ ê¸°ìˆ ì  ì§€ì§€ë ¥ í™•ì¸",
  "primary_risk": "ì—­ì‚¬ì  ê³ ì  ë¶€ê·¼ì—ì„œì˜ RSI ê³¼ì—´ ì‹œê·¸ë„ ë° ë³€ë™ì„± í™•ëŒ€ ê°€ëŠ¥ì„±",
  "executive_summary": "ë™ì‚¬ëŠ” ìµœê·¼ ì‹¤ì  ë°œí‘œë¥¼ í†µí•´ ìˆ˜ìµì„± íšŒë³µì˜ ì‹ í˜¸ë¥¼ ë³´ëƒˆìœ¼ë‚˜, ì£¼ê°€ëŠ” ì´ë¯¸ ìƒë‹¹ ë¶€ë¶„ ì„ ë°˜ì˜ëœ ìƒíƒœì…ë‹ˆë‹¤. ì¬ë¬´ ì°¨íŠ¸ìƒì˜ ì˜ì—…ì´ìµë¥  yì¶•ì´ ë°˜ë“±í•˜ê³  ìˆìœ¼ë‚˜, ê¸°ìˆ ì  ì§€í‘œìƒì˜ RSIê°€ ì„ê³„ê°’ì— ë„ë‹¬í•¨ì— ë”°ë¼ ë‹¨ê¸°ì ì¸ ìˆ¨ê³ ë¥´ê¸° êµ­ë©´ì´ ì˜ˆìƒë©ë‹ˆë‹¤. ë”°ë¼ì„œ í˜„ì¬ëŠ” ê³µê²©ì ì¸ ì¶”ê°€ ë§¤ìˆ˜ë³´ë‹¤ëŠ” ê¸°ì¡´ í¬ì§€ì…˜ì„ ìœ ì§€í•˜ë©° ì¡°ì • ì‹œ ë¶„í•  ë§¤ìˆ˜ ìœˆë„ìš°ë¥¼ íƒìƒ‰í•˜ëŠ” ì „ëµì´ ìœ íš¨í•©ë‹ˆë‹¤.",
  "fundamental_analysis": "ë§¤ì¶œ ì¶”ì„¸ ì°¨íŠ¸ì˜ xì¶•ì„ ë”°ë¼ê°€ë©´ ì§€ë‚œ 3ê°œ ë¶„ê¸° ë™ì•ˆ ì •ì²´ë˜ì—ˆë˜ ì„±ì¥ì´ ìµœê·¼ ë¶„ê¸°ë¶€í„° ê°€íŒŒë¥¸ ìš°ìƒí–¥ ê³¡ì„ ì„ ê·¸ë¦¬ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤. yì¶• ìˆ˜ì¹˜ìƒ ë§¤ì¶œì•¡ì€ 15% ì¦ê°€ì— ê·¸ì³¤ìœ¼ë‚˜, ì˜ì—…ì´ìµë¥ ì´ 14%ëŒ€ë¥¼ íšŒë³µí•˜ë©° í€ë”ë©˜í„¸ì˜ ì²´ì§ˆ ê°œì„ ì´ ëšœë ·í•˜ê²Œ ê´€ì°°ë©ë‹ˆë‹¤.",
  "valuation_analysis": "ë°¸ë¥˜ì—ì´ì…˜ ê²Œì´ì§€ì˜ yì¶• ì§€í‘œì¸ PEG 0.85ëŠ” ë™ì‚¬ì˜ ì„±ì¥ ì ì¬ë ¥ ëŒ€ë¹„ í˜„ì¬ ì£¼ê°€ê°€ ì—¬ì „íˆ í•©ë¦¬ì ì¸ êµ¬ê°„ì„ì„ ì‹œì‚¬í•©ë‹ˆë‹¤. íŠ¹íˆ ROEì™€ ìœ ë™ë¹„ìœ¨ì´ ì—…ì¢… í‰ê·  ìƒë‹¨ì— ìœ„ì¹˜í•˜ì—¬ ì¬ë¬´ì  ì•ˆì „íŒ ì—­í• ì„ ì¶©ì‹¤íˆ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
  "technical_analysis": "ì°¨íŠ¸ìƒ 200ì¼ ì´ë™í‰ê· ì„ ì˜ xì¶• ê¸°ìš¸ê¸°ê°€ í‰íƒ„í™” ê³¼ì •ì„ ê±°ì³ ìš°ìƒí–¥ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì¥ê¸°ì ì¸ ì¶”ì„¸ ë°˜ì „ì˜ ê°•ë ¥í•œ ì‹ í˜¸ì´ë‚˜, RSI ë§‰ëŒ€ ì°¨íŠ¸ê°€ yì¶• ê¸°ì¤€ 80ì„ ìƒíšŒí•˜ëŠ” ê³¼ë§¤ìˆ˜ êµ¬ê°„ì— ì§„ì…í–ˆìœ¼ë¯€ë¡œ ë‹¨ê¸° ì´ê²© ì¡°ì •ì— ëŒ€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤.",
  "risk_analysis": "ì—­ì‚¬ì  MDD ì°¨íŠ¸ì—ì„œ yì¶• -45%ì˜ ê¹Šì€ ê³¨ì„ í™•ì¸í–ˆì„ ë•Œ, í˜„ì¬ì˜ ì£¼ê°€ ìœ„ì¹˜ì—ì„œ í•˜ë½ ì „í™˜ ì‹œ íˆ¬ììê°€ ê°ë‚´í•´ì•¼ í•  ì‹¬ë¦¬ì  ë³€ë™ í­ì´ ë§¤ìš° í½ë‹ˆë‹¤. VaR(5%) ê¸°ì¤€ ì¼ê°„ -2.5%ì˜ ì ì¬ì  ì†ì‹¤ ìœ„í—˜ì„ ìƒì •í•˜ê³  ìì‚° ë°°ë¶„ ë¹„ì¤‘ì„ ì¡°ì ˆí•´ì•¼ í•©ë‹ˆë‹¤."
}
```

## ì¤‘ìš” ê·œì¹™
- ë°˜ë“œì‹œ ```json ... ``` ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ ê°ì‹¸ì‹­ì‹œì˜¤.
- ë¬¸ì¥ ê°„ì˜ ë…¼ë¦¬ì  ì—°ê²°ì„ ê°•í™”í•˜ê³ , ì¸ì‚¬ì´íŠ¸ì™€ ì°¨íŠ¸ ë°ì´í„° ì„¤ëª…ì„ ê· í˜• ìˆê²Œ ë°°ì¹˜í•˜ì‹­ì‹œì˜¤.
- **ë„ì–´ì“°ê¸°ë¥¼ ì² ì €íˆ í•˜ë˜, ë‹¨ì–´ ì¤‘ê°„ì— ì˜¤íƒ€ì„± ê³µë°±ì´ ìƒê¸°ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì‹­ì‹œì˜¤.**
- ìˆ˜ì‹ì–´ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ë³´ê³ ì„œì˜ ì „ë¬¸ì„±ì„ ë†’ì´ë˜, ê·¼ê±° ì—†ëŠ” ì°¬ì–‘ì€ ë°°ì œí•˜ì‹­ì‹œì˜¤.
- **`conclusion`, `report_markdown` í•„ë“œëŠ” ì ˆëŒ€ ìƒì„±í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** (ì¤‘ë³µ ë°©ì§€)
"""

import logging
logger = logging.getLogger(__name__)

class LLMService:
    def __init__(self):
        self.client = anthropic.AsyncAnthropic(api_key=settings.ANTHROPIC_API_KEY)

    async def generate_report(self, analysis_data: dict) -> dict:
        symbol = analysis_data.get("symbol")
        company_name = analysis_data.get("company_name", symbol)
        data_context = json.dumps(analysis_data, indent=2, ensure_ascii=False)

        logger.info(f"ğŸš€ [LLM] {company_name} ({symbol}) ë¶„ì„ ì‹œì‘...")
        try:
            message = await self.client.messages.create(
                model="claude-sonnet-4-5",
                max_tokens=4000,  # ë¶„ëŸ‰ í™•ëŒ€ë¥¼ ìœ„í•´ ìƒí–¥ ì¡°ì •
                temperature=0.3,    
                system=RESEARCH_REPORT_PROMPT,
                messages=[
                    {
                        "role": "user",
                        "content": f"ë‹¤ìŒ ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ {company_name} ({symbol}) ì¢…ëª©ì— ëŒ€í•œ ê¸°ê´€íˆ¬ìììš© ë¦¬ì„œì¹˜ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤. ì ˆëŒ€ë¡œ ì‘ë‹µì´ ì¤‘ê°„ì— ëŠì–´ì§€ì§€ ì•Šë„ë¡ JSON í˜•ì‹ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì‹­ì‹œì˜¤.\n\n[ë°ì´í„°]\n{data_context}"
                    }
                ]
            )
            response_text = message.content[0].text
            logger.info(f"âœ… [LLM] ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ (ê¸¸ì´: {len(response_text)})")

            # JSON íŒŒì‹±
            try:
                # ê°€ì¥ ë°”ê¹¥ìª½ì˜ { } ë¸”ë¡ì„ ì°¾ìŒ
                start_idx = response_text.find('{')
                end_idx = response_text.rfind('}')
                
                if start_idx != -1 and end_idx != -1 and end_idx > start_idx:
                    json_str = response_text[start_idx:end_idx+1].strip()
                else:
                    json_str = response_text
                
                # íŒŒì‹± ì‹œë„
                try:
                    llm_output = json.loads(json_str)
                except json.JSONDecodeError:
                    # ì ˆë‹¨ëœ JSON ë³µêµ¬ ì‹œë„: ë§ˆì§€ë§‰ ì™„ì „í•œ í•„ë“œê¹Œì§€ë§Œ íŒŒì‹±
                    logger.warning("âš ï¸ [LLM] JSON ì ˆë‹¨ ê°ì§€, ë³µêµ¬ ì‹œë„ ì¤‘...")
                    
                    # ë§ˆì§€ë§‰ ì™„ì „í•œ "key": "value" ìŒ ì´í›„ë¡œ ìë¥´ê¸°
                    last_quote = json_str.rfind('"')
                    if last_quote > 0:
                        # ë§ˆì§€ë§‰ ë”°ì˜´í‘œ ì´ì „ì˜ ë§ˆì§€ë§‰ ì½¤ë§ˆ ë˜ëŠ” ì¤‘ê´„í˜¸ ì°¾ê¸°
                        search_area = json_str[:last_quote]
                        last_comma = search_area.rfind(',')
                        
                        if last_comma > 0:
                            # ë§ˆì§€ë§‰ ì½¤ë§ˆê¹Œì§€ ìë¥´ê³  ë‹«ëŠ” ì¤‘ê´„í˜¸ ì¶”ê°€
                            recovered_json = json_str[:last_comma] + '}'
                            llm_output = json.loads(recovered_json)
                            logger.info("âœ… [LLM] ì ˆë‹¨ëœ JSON ë³µêµ¬ ì„±ê³µ")
                        else:
                            raise  # ë³µêµ¬ ë¶ˆê°€ëŠ¥, ì›ë˜ ì—ëŸ¬ ë°œìƒ
                    else:
                        raise  # ë³µêµ¬ ë¶ˆê°€ëŠ¥

                logger.info(f"âœ¨ [LLM] JSON íŒŒì‹± ë° ë°ì´í„° êµ¬ì¡°í™” ì„±ê³µ")

                # ë¬¸ìì—´ í•„ë“œ ì •ë¦¬
                for key in ['key_thesis', 'primary_risk']:
                    if key in llm_output and isinstance(llm_output[key], str):
                        llm_output[key] = llm_output[key].replace('\n', ' ').strip()
                
                # ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ëŠ” ì´ì œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¡°ë¦½í•˜ë¯€ë¡œ ë°±ì—”ë“œì—ì„œëŠ” ìƒì„±í•˜ì§€ ì•ŠìŒ
                if "report_markdown" in llm_output:
                    del llm_output["report_markdown"]
                if "conclusion" in llm_output:
                    del llm_output["conclusion"]

                # ë””ë²„ê·¸ ì •ë³´ ì¶”ê°€
                llm_output["_debug"] = {
                    "full_prompt": f"System: {RESEARCH_REPORT_PROMPT}\n\nUser: {company_name} ({symbol}) ë°ì´í„° ë¶„ì„ ìš”ì²­",
                    "raw_data_sent": analysis_data,
                    "raw_response": response_text
                }
                
                # ì„±ê³µ í”Œë˜ê·¸ ì¶”ê°€
                llm_output["is_success"] = True

                return llm_output
                
            except json.JSONDecodeError as e:
                logger.error(f"âŒ JSON íŒŒì‹± ì—ëŸ¬: {e}")
                logger.error(f"ğŸ“„ ì›ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸: {response_text}")
            
        except Exception as e:
            logger.error(f"âŒ LLM í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {type(e).__name__} - {e}")
            import traceback
            traceback.print_exc()

        
        # ê¸°ë³¸ ì‘ë‹µ (íŒŒì‹± ì‹¤íŒ¨ ë˜ëŠ” ì˜ˆì™¸ ë°œìƒ ì‹œ)
        return {
            "investment_rating": "ë°ì´í„° ë¶„ì„ ì œí•œ",
            "current_price": 0,
            "key_thesis": "ë°ì´í„° ìˆ˜ì§‘ ë¶€ì¡± ë˜ëŠ” ë¶„ì„ ì˜¤ë¥˜",
            "primary_risk": "ë¦¬ìŠ¤í¬ ì‚°ì¶œ ë¶ˆê°€",
            "is_success": False
        }

llm_service = LLMService()
